pattern:
  name: slave_servers
<%-
require 'net/http'
require 'json'
require 'uri'
# move to https://github.com/dalen/puppet-puppetdbquery in future
headers = { 'Accept' => 'application/json' }
query    = ['and', ['=', 'exported', true], ['~', 'title', 'dns__export_']]
uri      = '/pdb/query/v4/resources/Nsd::Remote'
uri      += URI.escape("?query=#{query.to_json}")
http     = Net::HTTP.new(@puppetdb_server, @puppetdb_port)
begin
  response = http.get(uri, headers)
  if response.code != "200"
    scope.call_function(
      'warning', 
      ["unable to connect to the puppet server, exported resources wont work: #{response.code}"]
    )
  end
  response_json = JSON.parse(response.body)
  response_json.each do |resource|
-%>
  include-pattern: <%= resource['title'] %>-provide-xfr
<%-
  end
rescue Exception => e
  scope.call_function('warning', ["unable to connect to the puppetdb server, exported resources wont work: #{e}"])
end
%>
